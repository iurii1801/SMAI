# Лабораторная работа №5. Использование Grafana для визуализации данных Zabbix

## Цель работы

Целью работы является изучение платформы **Grafana** и визуализация данных, собираемых системой **Zabbix**, включая установку Grafana, настройку плагина Zabbix, подключение к API и создание собственных интерактивных дашбордов.

## Задачи

- Установить и запустить сервис Grafana.
- Установить и активировать официальный плагин Zabbix для Grafana.
- Настроить подключение между Grafana и Zabbix API.
- Создать персональный dashboard с панелями, использующими данные из Zabbix.
- Работать с переменными, фильтрацией и различными видами визуализации.
- Создать правило оповещения (alert) в Grafana на основе данных Zabbix.
- Экспортировать дашборд.

## Необходимые ресурсы

- Сервер Linux (Ubuntu/Debian) с доступом по SSH.
- Установленный и работающий сервер Zabbix (Zabbix Server + Zabbix Agent).
- URL/API-адрес сервера Zabbix и пользователь с правами чтения.
- Веб-браузер.

---

## Ход выполнения работы

### Шаг 1. Установка `Grafana`

Для установки системы визуализации необходимо поочерёдно выполнить ряд действий, начиная с добавления официального репозитория `Grafana` и заканчивая запуском службы.

#### Добавление репозитория и вспомогательных компонентов

Сначала необходимо установить утилиты, которые требуются для загрузки ключей и работы с HTTPS-репозиториями.
Для этого следует выполнить следующую команду:

```bash
sudo apt-get install -y apt-transport-https software-properties-common wget
```

После установки утилит необходимо добавить официальный GPG-ключ `Grafana`, позволяющий системе проверять пакеты.
Для этого выполняется команда:

```bash
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
```

Далее следует добавить репозиторий `Grafana` в список источников пакетов.
Для этого требуется выполнить команду:

```bash
echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee /etc/apt/sources.list.d/grafana.list
```

![image](https://i.imgur.com/je03map.png)

После добавления репозитория необходимо обновить список пакетов, чтобы система увидела новые источники.
Это выполняется командой:

```bash
sudo apt update
```

![image](https://i.imgur.com/pslCy3l.png)

#### Установка сервиса `Grafana`

Затем требуется установить сам сервис `Grafana`.
Для этого выполняется следующая команда:

```bash
sudo apt install grafana -y
```

![image](https://i.imgur.com/w7lrLH7.png)

#### Запуск и активация службы `Grafana Server`

После завершения установки необходимо запустить веб-сервер `Grafana`.
Для этого выполняется команда:

```bash
sudo systemctl start grafana-server
```

Далее следует добавить сервис в автозагрузку, чтобы он запускался автоматически при старте системы.
Для этого требуется выполнить команду:

```bash
sudo systemctl enable grafana-server
```

Чтобы убедиться, что сервис запущен, необходимо проверить его состояние с помощью команды:

```bash
sudo systemctl status grafana-server
```

![image](https://i.imgur.com/obeQ5Fj.png)

Видно, что служба находится в состоянии **active (running)**

### Шаг 2. Установка плагина Zabbix для `Grafana`

После установки Grafana необходимо добавить официальный плагин, который позволяет системе визуализации получать данные напрямую из Zabbix. Для этого требуется выполнить несколько последовательных действий.

#### Установка плагина

Сначала необходимо установить официальный плагин `alexanderzobnin-zabbix-app`, обеспечивающий взаимодействие `Grafana` с API Zabbix.
Для этого следует выполнить команду:

```bash
sudo grafana-cli plugins install alexanderzobnin-zabbix-app
```

![image](https://i.imgur.com/UdqqZnc.png)

#### Проверка состояния службы

После завершения установки необходимо перезапустить сервис `grafana-server`, чтобы изменения вступили в силу.
Для этого выполняется команда:

```bash
sudo systemctl restart grafana-server
```

Затем требуется убедиться, что сервис корректно запустился после установки плагина.
Для проверки состояния выполняется команда:

```bash
sudo systemctl status grafana-server
```

На экране отображается активное состояние **active (running)**, что подтверждает успешное применение плагина:

![image](https://i.imgur.com/jBvTF7e.png)

### Шаг 3. Подключение `Grafana` к `Zabbix API`

После установки `Grafana` и плагина `Zabbix` необходимо выполнить первичную настройку веб-интерфейса и добавить источник данных на основе Zabbix API.

#### Открытие веб-интерфейса Grafana и вход

Сначала требуется открыть в браузере веб-интерфейс `Grafana`, указав адрес сервера и порт по умолчанию `3000`:

```text
http://192.168.100.1:3000
```

На странице авторизации необходимо ввести учётные данные администратора `Grafana` (пользователь `admin` и заданный пароль) и выполнить вход в систему.

![image](https://i.imgur.com/mCSn5jo.png)

После успешной авторизации открывается стартовая страница «Welcome to Grafana» с основными блоками настройки.

![image](https://i.imgur.com/P5Mecmy.png)

#### Проверка наличия плагина Zabbix

Далее требуется убедиться, что плагин Zabbix доступен в интерфейсе.
Для этого необходимо перейти в раздел:

`Administration → Plugins and data → Plugins`

В поле поиска нужно ввести `zabbix`. В списке появляется плагин **Zabbix** со статусом `Installed`.

![image](https://i.imgur.com/5YT4iBt.png)

После этого можно открыть страницу плагина и убедиться, что он успешно установлен и подписан (`Signed`), а также посмотреть краткое описание и версию.

![image](https://i.imgur.com/HfKEfzV.png)

#### Добавление источника данных Zabbix в Grafana

Затем требуется добавить новый источник данных, который будет обращаться к API сервера Zabbix.
Для этого выполняется переход:

`Connections → Data sources → Add data source`

В поле поиска необходимо ввести `zabbix` и выбрать появившийся тип источника **Zabbix**.

![image](https://i.imgur.com/nfUmZap.png)

После выбора открывается страница настроек источника данных.

#### Настройка подключения к Zabbix API

В блоке **Connection** необходимо указать URL до API Zabbix. В качестве адреса используется IP-адрес сервера Zabbix и путь к файлу `api_jsonrpc.php`:

```text
http://192.168.100.1/zabbix/api_jsonrpc.php
```

Поле `URL *` должно содержать именно этот путь.

![image](https://i.imgur.com/EgFvAAZ.png)

В секции **Authentication** следует оставить вариант `No Authentication`, так как авторизация для Zabbix выполняется отдельно в блоке плагина.

Ниже, в разделе **Zabbix Connection**, необходимо выбрать тип аутентификации `User and password`, указать имя пользователя Zabbix (`Admin`) и пароль, который был задан для учётной записи администратора.

![image](https://i.imgur.com/1O16j28.png)

Остальные параметры (кэш, таймаут, настройки трендов) оставляются по умолчанию.

#### Проверка подключения (Save & Test)

После заполнения всех полей требуется сохранить настройки и проверить соединение.
Для этого нажимается кнопка:

```text
Save & test
```

В нижней части окна появляется зелёное уведомление вида:

```text
Zabbix API version: 6.4.21
Next, you can start to visualize data by building a dashboard...
```

Это означает, что Grafana успешно подключилась к Zabbix API и может получать метрики для визуализации.

![image](https://i.imgur.com/5DM37Nf.png)

### Шаг 4. Создание Dashboard в Grafana на основе данных Zabbix

После успешного подключения Grafana к API Zabbix можно переходить к построению визуализаций на основе данных мониторинга.
В рамках лабораторной работы требуется создать новый Dashboard и добавить панели (panels), отображающие ключевые метрики: загрузку CPU, использование памяти, сетевой трафик, дисковое пространство и статус Zabbix Agent.

#### Создание нового Dashboard

Для начала необходимо перейти в меню:

`Dashboards → New → New dashboard`

Откроется стартовая страница создания нового Dashboard с предложением добавить первую визуализацию.

Для добавления панели необходимо нажать на кнопку `+ Add visualization`.

После этого Grafana предложит выбрать источник данных. Необходимо выбрать:

`Data source → Zabbix`

#### Панель a. CPU Load (Загрузка процессора)

Цель панели — отобразить **Load average (1 min)**, что соответствует средней загрузке CPU за минуту.

В открывшихся настройках необходимо заполнить:

- **Query type:** `Metrics`
- **Group:** `Linux servers`
- **Host:** `zabbix-agent`
- **Item:** `CPU Load avg1`
- **Visualization:** `Time series`

![image](https://i.imgur.com/r3azxC3.png)

На графике отображается изменение нагрузки CPU во времени.

#### Панель b. Memory (Использование памяти)

Цель панели — проанализировать использование оперативной памяти на сервере.

Необходимо создать новую панель:

- **Query A:**

  - Query type: `Metrics`
  - Item: `RAM Used %` — процент использованной оперативной памяти

- **Query B:**

  - Query type: `Metrics`
  - Item: `RAM/CPU Efficiency Ratio` — коэффициент эффективности

Так как шаблон Zabbix, используемый в работе, не предоставляет отдельного Item вида "Available memory", используется показатель Used %.

![image](https://i.imgur.com/70ezm8w.png)

Тип визуализации — **Time series**, что позволяет наблюдать динамику использования памяти.

#### Панель c. Network Traffic (Сетевой трафик)

Цель панели — отобразить входящий и исходящий трафик на интерфейсе.

Необходимо добавить две метрики:

- **Query A:**

  - Item: `Network Traffic In` — входящий трафик

- **Query B:**

  - Item: `Network Traffic Out` — исходящий трафик

![image](https://i.imgur.com/eXuiZFX.png)

Обе серии отображаются на одном графике, что удобно для сравнения.

#### Панель d. Filesystem (Дисковое пространство)

Цель панели — показать, сколько места занято и сколько свободно на диске.

- **Query A (метрика):**

  - Item: `Disk Space Used %` — процент занятого пространства

- **Query B (выражение):**

Необходимо использовать механизм `Expression`:

```
Operation: Math
Expression: 100 - $A
```

Таким образом:

- `$A` — занято
- `100 - $A` — свободно

![image](https://i.imgur.com/2fV8Igg.png)

#### Панель e. Zabbix Agent Ping (статус агента)

Цель панели — отображать доступность Zabbix Agent на хосте.

Item `agent.ping` возвращает:

- `1` — агент доступен
- `0` — агент недоступен

Настройка панели:

- **Query type:** Metrics
- **Group:** `Linux servers`
- **Host:** `zabbix-agent`
- **Item:** `Zabbix agent ping`
- **Visualization:** `Stat` (числовой индикатор)

![image](https://i.imgur.com/44cwQbe.png)

При успешном подключении значение становится равным **1**, что означает нормальную работу агента.

В результате выполнения шага был полностью создан Dashboard с пятью ключевыми панелями, каждая из которых отображает соответствующие метрики, получаемые через Zabbix API:

1. CPU Load
2. Memory
3. Network Traffic
4. Disk Space
5. Agent Ping

Dashboard корректно отображает данные, обновляется в реальном времени и полностью соответствует требованиям задания.

### Шаг 5. Создание переменных в Grafana (`group` и `host`)

Переменные позволяют динамически выбирать группы и хосты Zabbix прямо из Dashboard, без изменения настроек панелей. Необходимо создать две переменые. Для корректной работы переменной `host` необходимо создать также переменную `group`.

#### Создание переменной `group`

Первая переменная предназначена для выбора группы хостов Zabbix.

Нужно перейти по пути:

`Dashboard → Settings → Variables → Add variable`

#### **Основные параметры**

| Поле        | Значение |
| ----------- | -------- |
| Name        | `group`  |
| Type        | `Query`  |
| Data source | `Zabbix` |

#### **Query Options**

| Параметр     | Значение |
| ------------ | -------- |
| Query Type   | `Group`  |
| Group filter | `/.*/`   |

Выражение `/.*/` используется для отображения всех групп.

#### **Selection options**

| Настройка           | Статус    |
| ------------------- | --------- |
| Multi-value         | Отключено |
| Allow custom values | Включено  |
| Include All option  | Включено  |

![image](https://i.imgur.com/bes7R73.png)
![image](https://i.imgur.com/bdKqPdS.png)

После заполнения необходимо нажать `Run query`, а потом `Save`.

В предпросмотре появятся значения:

| Пример значений |
| --------------- |
| All             |
| Linux servers   |
| Zabbix servers  |

#### Создание переменной `host`

Следующая переменная используется для отображения хостов, относящихся к выбранной группе.

Нужно перейти по пути:

`Dashboard → Settings → Variables → Add variable`

#### **Основные параметры**

| Поле        | Значение |
| ----------- | -------- |
| Name        | `host`   |
| Type        | `Query`  |
| Data source | `Zabbix` |

#### **Query Options**

| Параметр    | Значение |
| ----------- | -------- |
| Query Type  | `Host`   |
| Group       | `$group` |
| Host filter | `/.*/`   |

Использование переменной `$group` позволяет автоматически подгружать список хостов выбранной группы.

#### **Selection options**

| Настройка           | Статус   |
| ------------------- | -------- |
| Multi-value         | Включено |
| Allow custom values | Включено |
| Include All option  | Включено |

![image](https://i.imgur.com/svrdtWF.png)
![image](https://i.imgur.com/egEAKGs.png)

После заполнения необходимо нажать `Run query`, а потом `Save`.

В предпросмотре появятся значения:

| Значения      |
| ------------- |
| All           |
| Zabbix server |
| zabbix-agent  |

#### Проверка работы переменных

После сохранения обе переменные отображаются в верхней части Dashboard:

![image](https://i.imgur.com/JXm5XHf.png)

Теперь можно выбирать:

- группу (group)
- хост (host), автоматически подстраивающийся под выбранную группу

Все панели, использующие переменные (`$group`, `$host`), будут обновляться динамически.

### Шаг 6. Создание оповещений (Alerts) в Grafana на основе данных Zabbix

Для настройки системы оповещений необходимо выполнить ряд шагов в интерфейсе Grafana.

#### Создание контактного канала Telegram

Для начала требуется настроить канал, через который будут отправляться уведомления.

Следует перейти в меню **Alerting → Contact points** и создать новый контактный пункт.
Выбирается тип интеграции **Telegram**, после чего необходимо указать:

- Bot API Token, полученный через BotFather
- Chat ID, полученный посредством Telegram API

После заполнения полей контактный канал сохраняется, а затем требуется выполнить тестовую отправку уведомления, чтобы убедиться в корректной связи.

![image](https://i.imgur.com/OHoFsDl.png)
![image](https://i.imgur.com/ep44CHB.png)

#### Создание нового правила оповещения

Чтобы создать оповещение, необходимо открыть раздел **Alerting → Alert rules** и нажать кнопку создания нового правила.

Далее задаётся имя правила, например **CPU Load High**, и выбирается источник данных — Zabbix.
Следует указать:

- группу хостов **Linux servers**
- хост **zabbix-agent**
- элемент данных **CPU Load avg1**

После выбора данных на экране отображается график метрики.

![image](https://i.imgur.com/juT0kFK.png)

#### Настройка условия срабатывания

На следующем этапе требуется задать условие, при котором правило будет переходить в состояние Firing.
Используется тип проверки **Is above**, где указывается пороговое значение:

> `CPU Load avg1 > 1.5`

В качестве входных данных выбирается последнее значение метрики (Last).
Для визуальной проверки необходимо использовать кнопку предварительного просмотра.

#### Настройка параметров оценки (Evaluation behavior)

Затем следует настроить поведение оценки.
Здесь задаётся:

- интервал проверки: **Every 1 minute**
- период ожидания перед срабатыванием: **Pending period — 5 minutes**

Эта настройка позволяет избежать ложных срабатываний при кратковременных всплесках нагрузки.

![image](https://i.imgur.com/MDR0DZC.png)

#### Настройка уведомлений

На этапе выбора получателей уведомлений необходимо указать контактный канал Telegram, созданный ранее.

Grafana будет использовать этот канал для отправки сообщений при активации и устранении проблемы.

![image](https://i.imgur.com/jCavK6z.png)

#### Настройка содержания уведомления

Следует задать текст уведомления, который будет отправляться пользователю.
Указываются следующие поля:

- **Summary** — краткое описание события
  (например: *High CPU load detected on {host}*)
- **Description** — подробное пояснение
  (например: *CPU Load avg1 exceeded threshold > 1.5*)

![image](https://i.imgur.com/zqJfCli.png)

#### Настройка Notification Policies

Для корректной маршрутизации оповещений требуется перейти в раздел **Alerting → Notification policies** и создать правило, направляющее все оповещения в Telegram.

Обычно указывается условие по метке `alertname`, которое подходит под любое правило, и выбирается контактный пункт Telegram.

![image](https://i.imgur.com/qLQqttE.png)

#### Проверка срабатывания оповещения

Для тестирования работы правила необходимо создать нагрузку на процессор.
Это выполняется с помощью утилиты:

```bash
stress-ng -c 4 -t 90s
```

![image](https://i.imgur.com/MkPsMv8.png)

После того как нагрузка превысила порог, правило перешло в состояние **Firing**, а в Telegram было доставлено уведомление с подробностями:

- имя алерта
- значение метрики
- хост и элемент
- описание
- ссылки на Dashboard и Silence

![image](https://i.imgur.com/ynKJCUa.png)

#### Восстановление (Resolved)

Когда нагрузка на CPU снизилась, условие перестало выполняться, и правило автоматически перешло в состояние **Resolved**.
В Telegram пришло сообщение о восстановлении.

![image](https://i.imgur.com/k4xLRn0.png)

### Шаг 7. Экспорт Dashboard в формате JSON

Для экспорта созданного дашборда необходимо открыть панель, содержащую графики и настроенные alert-правила.

Затем требуется нажать на меню в правом верхнем углу панели **(иконка “⋯” или шестерёнка)** и выбрать пункт:

`Dashboard settings → Export → Export as code`

После выбора опции Grafana автоматически выгружает дашборд в виде JSON-файла, который нужно сохранить.

![image](https://i.imgur.com/PCCIR8c.png)

---

## Вывод

В ходе лабораторной работы была настроена полноценная система мониторинга на базе `Zabbix` и `Grafana`. Установлен плагин `Zabbix`, подключён источник данных через `API` и проверена корректность получения метрик. На основе данных были созданы панели визуализации и настроен дашборд. Реализовано оповещение о высокой загрузке `CPU`: создано `alert`-правило, настроен контактный пункт Telegram и политика уведомлений. Корректность работы алёртов подтверждена тестовой нагрузкой и успешной доставкой сообщений в Telegram. Дашборд экспортирован в формате JSON. Работа продемонстрировала успешную интеграцию `Zabbix` и `Grafana`, а также настройку автоматических оповещений.

---

## Контрольные вопросы

**1. Для чего необходим плагин Zabbix в Grafana?**

Плагин Zabbix предоставляет Grafana возможность получать данные непосредственно из сервера Zabbix и визуализировать их в виде графиков, статических панелей и метрик.
Без него Grafana не может работать напрямую с Zabbix API и не умеет получать его метрики.

**2. Какую роль играет Zabbix API при настройке источника данных?**

Zabbix API используется Grafana для авторизации, получения списка хостов, элементов данных (items), триггеров и истории значений.
Через API Grafana запрашивает реальные метрики, выполняет фильтрацию и выводит их на панели.

**3. Чем отличается «Graph panel» от «Stat panel»?**

- **Graph panel** — отображает данные в виде графика по времени, используется для анализа динамики метрик (CPU Load, RAM usage, Traffic и т.д.).
- **Stat panel** — показывает текущее значение метрики в виде одного числа или индикатора, без временной линии.

Graph — это временной график.
Stat — это одиночное значение.

**4. Что такое переменная dashboard и как она используется?**

Переменная dashboard — это параметр, позволяющий динамически изменять содержимое панелей без изменения самого дашборда.
Используется для:

- выбора хоста
- выбора группы хостов
- выбора интерфейса, диска или метрики
- фильтрации данных

Переменная создаётся в **Dashboard → Settings → Variables** и применяется в запросах через синтаксис `$variable`.

**5. Как настраивается alert на основе данных Zabbix?**

Для создания alert-правила необходимо:

1. выбрать панель с метрикой (например, CPU Load avg1);
2. перейти в **Alert → Create alert rule**;
3. указать источник данных **Zabbix**;
4. задать условие (например: *Last > 1.5*);
5. выбрать интервал проверки и период ожидания;
6. указать канал уведомлений (Telegram, email и т.д.);
7. сохранить правило и протестировать срабатывание.

Alert работает на основе данных, полученных от Zabbix API через плагин.



